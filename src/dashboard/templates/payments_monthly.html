{% extends 'base.html' %}
{% load static %}
{% load formatting %}

{% block title %}Monthly Payments{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Monthly payments overview</h6>
          <div class="d-flex align-items-center">
            <form method="get" class="d-flex align-items-center me-2" action="">
              <div class="me-2">
                <label for="month" class="form-label mb-0">Month</label>
                <input type="number" min="1" max="12" id="month" name="month" value="{{ month }}" class="form-control form-control-sm" />
              </div>
              <div class="me-2">
                <label for="year" class="form-label mb-0">Year</label>
                <input type="number" id="year" name="year" value="{{ year }}" class="form-control form-control-sm" />
              </div>
              <div class="mt-4">
                <button type="submit" class="btn btn-sm btn-primary">Filter</button>
              </div>
            </form>
            <a href="#" class="btn btn-sm btn-success mt-4 me-2" data-modal-target="addPaymentModal" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
              <i class="fas fa-plus me-1"></i> Add Payment
            </a>
            <a href="#" class="btn btn-sm btn-outline-primary mt-4" data-modal-target="reportModal" data-bs-toggle="modal" data-bs-target="#reportModal">
              <i class="fas fa-file-pdf me-1"></i> Generate Report
            </a>
          </div>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            {% if grouped %}
              {% for prop_id, pdata in grouped.items %}
                <div class="px-4 pt-4">
                  {% if pdata.property %}
                    <div class="d-flex align-items-center bg-light rounded px-3 py-2 border">
                      <div class="icon icon-shape text-white bg-gradient-info rounded-circle me-2 d-flex align-items-center justify-content-center" style="width:28px;height:28px;">
                        <i class="fas fa-building"></i>
                      </div>
                      <h6 class="mb-0 text-secondary text-sm">{{ pdata.property }}</h6>
                    </div>
                  {% endif %}
                </div>
                <table class="table table-hover table-striped align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tenant</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Base rent</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Coop</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Electricity</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Gas</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Other</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Total</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Status</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Due date</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in pdata.payments %}
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm">
                              {% if p.rental_agreement and p.rental_agreement.tenant %}
                                {{ p.rental_agreement.tenant }}
                              {% else %}
                                <em>Unknown tenant</em>
                              {% endif %}
                            </h6>
                          </div>
                        </div>
                      </td>
                      <td><span class="text-xs font-weight-bold">{{ p.base_rent|two_dec }}</span></td>
                      <td><span class="text-xs font-weight-bold">{{ p.coop_fee|two_dec }}</span></td>
                      <td><span class="text-xs font-weight-bold">{{ p.electricity|two_dec }}</span></td>
                      <td><span class="text-xs font-weight-bold">{{ p.gas|two_dec }}</span></td>
                      <td><span class="text-xs font-weight-bold">{{ p.other_fees|two_dec }}</span></td>
                      <td><span class="text-xs font-weight-bold">{{ p.total_amount|two_dec }}</span></td>
                      <td>
                        {% if p.status == 1 %}
                          <span class="badge badge-sm bg-gradient-secondary">Pending</span>
                        {% elif p.status == 2 %}
                          <span class="badge badge-sm bg-gradient-success">Paid</span>
                        {% elif p.status == 3 %}
                          <span class="badge badge-sm bg-gradient-danger">Overdue</span>
                        {% elif p.status == 4 %}
                          <span class="badge badge-sm bg-gradient-dark">Cancelled</span>
                        {% endif %}
                      </td>
                      <td><span class="text-xs font-weight-bold">{{ p.date_due }}</span></td>
                      <td>
                        <a class="text-secondary font-weight-bold text-xs me-2" href="{% url 'payment_edit' p.pk %}"><i class="fas fa-edit"></i> Edit</a>
                        <a class="text-danger font-weight-bold text-xs" href="{% url 'payment_delete' p.pk %}"><i class="fas fa-trash"></i> Delete</a>
                      </td>
                    </tr>
                    {% endfor %}
                    <tr class="bg-secondary text-white">
                      <td colspan="6" class="text-end"><strong>Property total:</strong></td>
                      <td><strong>{{ pdata.property_total|two_dec }}</strong></td>
                      <td colspan="3"></td>
                    </tr>
                  </tbody>
                </table>
              {% endfor %}
              <div class="px-4 pt-4 pb-4">
                <div class="row g-3">
                  <div class="col-sm-6 col-lg-4">
                    <div class="card shadow-sm border-0">
                      <div class="card-body d-flex align-items-center">
                        <div class="icon icon-shape text-white bg-gradient-success rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                          <i class="fas fa-wallet"></i>
                        </div>
                        <div>
                          <div class="text-xs text-uppercase text-secondary font-weight-bolder opacity-7">Overall monthly income</div>
                          <div class="h4 mb-0">{{ total_income|two_dec }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-6 col-lg-4">
                    <div class="card shadow-sm border-0">
                      <div class="card-body d-flex align-items-center">
                        <div class="icon icon-shape text-white bg-gradient-warning rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                          <i class="fas fa-receipt"></i>
                        </div>
                        <div>
                          <div class="text-xs text-uppercase text-secondary font-weight-bolder opacity-7">Overall monthly tax</div>
                          <div class="h4 mb-0">{{ total_tax|two_dec }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>


            {% else %}
              <div class="p-4">
                <em>No payments found for the selected month.</em>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'payment_add' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="id_rental_agreement">{{ payment_form.rental_agreement.label }}</label>
                {{ payment_form.rental_agreement }}
                {% if payment_form.rental_agreement.help_text %}
                  <div class="form-text">{{ payment_form.rental_agreement.help_text }}</div>
                {% endif %}
                {% for error in payment_form.rental_agreement.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="id_date_due">{{ payment_form.date_due.label }}</label>
                {{ payment_form.date_due }}
                {% if payment_form.date_due.help_text %}
                  <div class="form-text">{{ payment_form.date_due.help_text }}</div>
                {% endif %}
                {% for error in payment_form.date_due.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="id_date_paid">{{ payment_form.date_paid.label }}</label>
                {{ payment_form.date_paid }}
                {% if payment_form.date_paid.help_text %}
                  <div class="form-text">{{ payment_form.date_paid.help_text }}</div>
                {% endif %}
                {% for error in payment_form.date_paid.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="id_status">{{ payment_form.status.label }}</label>
                {{ payment_form.status }}
                {% if payment_form.status.help_text %}
                  <div class="form-text">{{ payment_form.status.help_text }}</div>
                {% endif %}
                {% for error in payment_form.status.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label" for="id_base_rent">{{ payment_form.base_rent.label }}</label>
                {{ payment_form.base_rent }}
                {% if payment_form.base_rent.help_text %}
                  <div class="form-text">{{ payment_form.base_rent.help_text }}</div>
                {% endif %}
                {% for error in payment_form.base_rent.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label" for="id_coop_fee">{{ payment_form.coop_fee.label }}</label>
                {{ payment_form.coop_fee }}
                {% if payment_form.coop_fee.help_text %}
                  <div class="form-text">{{ payment_form.coop_fee.help_text }}</div>
                {% endif %}
                {% for error in payment_form.coop_fee.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label" for="id_other_fees">{{ payment_form.other_fees.label }}</label>
                {{ payment_form.other_fees }}
                {% if payment_form.other_fees.help_text %}
                  <div class="form-text">{{ payment_form.other_fees.help_text }}</div>
                {% endif %}
                {% for error in payment_form.other_fees.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="id_electricity">{{ payment_form.electricity.label }}</label>
                {{ payment_form.electricity }}
                {% if payment_form.electricity.help_text %}
                  <div class="form-text">{{ payment_form.electricity.help_text }}</div>
                {% endif %}
                {% for error in payment_form.electricity.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="id_gas">{{ payment_form.gas.label }}</label>
                {{ payment_form.gas }}
                {% if payment_form.gas.help_text %}
                  <div class="form-text">{{ payment_form.gas.help_text }}</div>
                {% endif %}
                {% for error in payment_form.gas.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            </div>

            <div class="row">
              <div class="col-12 mb-3">
                <label class="form-label" for="id_invoice_url">{{ payment_form.invoice_url.label }}</label>
                {{ payment_form.invoice_url }}
                {% if payment_form.invoice_url.help_text %}
                  <div class="form-text">{{ payment_form.invoice_url.help_text }}</div>
                {% endif %}
                {% for error in payment_form.invoice_url.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Report Modal placed outside of Add Payment Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <form id="reportForm" method="get" action="{% url 'payments_report_pdf' %}" target="_blank">
        <div class="modal-header">
          <h5 class="modal-title" id="reportModalLabel">Generate Payments Report (PDF)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="reportYear" class="form-label">Year</label>
            <input type="number" class="form-control" id="reportYear" name="year" value="{{ year }}" required />
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="fullYearSwitch" name="full_year" value="1" checked>
            <label class="form-check-label" for="fullYearSwitch">Whole year</label>
          </div>
          <div class="row g-2" id="monthRangeRow">
            <div class="col-6">
              <label for="startMonth" class="form-label">Start month</label>
              <input type="number" class="form-control" id="startMonth" name="start_month" min="1" max="12" value="1" disabled>
            </div>
            <div class="col-6">
              <label for="endMonth" class="form-label">End month</label>
              <input type="number" class="form-control" id="endMonth" name="end_month" min="1" max="12" value="12" disabled>
            </div>
          </div>
          <div class="form-text">Select whole year or specify a month range within the year.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Generate PDF</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Open modal on buttons with data-modal-target, following the pattern used in Properties pages
  document.addEventListener('click', function (e) {
    const trigger = e.target.closest('[data-modal-target]');
    if (!trigger) return;
    const targetId = trigger.getAttribute('data-modal-target');
    if (targetId !== 'addPaymentModal' && targetId !== 'reportModal') return; // handle our modals
    e.preventDefault();
    const modalEl = document.getElementById(targetId);
    if (!modalEl) return;
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  });

  // Report modal logic
  (function() {
    function updateMonthInputs() {
      var fullYear = document.getElementById('fullYearSwitch').checked;
      var startEl = document.getElementById('startMonth');
      var endEl = document.getElementById('endMonth');
      startEl.disabled = fullYear;
      endEl.disabled = fullYear;
      if (fullYear) {
        startEl.value = 1; endEl.value = 12;
      }
    }
    document.addEventListener('DOMContentLoaded', function(){
      var fullYearSwitch = document.getElementById('fullYearSwitch');
      if (fullYearSwitch) {
        fullYearSwitch.addEventListener('change', updateMonthInputs);
        updateMonthInputs();
      }
      var form = document.getElementById('reportForm');
      if (form) {
        form.addEventListener('submit', function(e){
          var year = parseInt(document.getElementById('reportYear').value || '0', 10);
          if (!year || year < 2000 || year > 2100) {
            e.preventDefault();
            alert('Please enter a valid year (2000-2100).');
            return;
          }
          if (!document.getElementById('fullYearSwitch').checked) {
            var s = parseInt(document.getElementById('startMonth').value || '0', 10);
            var eM = parseInt(document.getElementById('endMonth').value || '0', 10);
            if (!(s >= 1 && s <= 12 && eM >= 1 && eM <= 12)) {
              e.preventDefault();
              alert('Start and end months must be between 1 and 12.');
              return;
            }
            if (s > eM) {
              // swap automatically instead of blocking
              document.getElementById('startMonth').value = eM;
              document.getElementById('endMonth').value = s;
            }
          }
        });
      }
    });
  })();

  // Autofill from Rental Agreement (copied from standalone payment_form)
  (function() {
    function fillFromAgreement(raId) {
      if (!raId) return;
      fetch(`/leases/${raId}/details.json`, {headers: {"X-Requested-With": "XMLHttpRequest"}})
        .then(function(resp){ if (!resp.ok) throw new Error('Failed to load agreement'); return resp.json(); })
        .then(function(data){
          var setVal = function(id, val){ var el = document.getElementById(id); if (el) { el.value = (val != null ? val : 0); el.dispatchEvent(new Event('change')); } };
          setVal('id_base_rent', data.base_rent);
          setVal('id_coop_fee', data.coop_fee);
          setVal('id_electricity', data.electricity);
          setVal('id_gas', data.gas);
          setVal('id_other_fees', data.other_fees);
        })
        .catch(function(err){ console.warn(err); });
    }

    document.addEventListener('DOMContentLoaded', function(){
      var raSelect = document.getElementById('id_rental_agreement');
      if (!raSelect) return;
      raSelect.addEventListener('change', function(){ fillFromAgreement(this.value); });
      if (raSelect.value) { fillFromAgreement(raSelect.value); }
    });
  })();
</script>
{% endblock %}
